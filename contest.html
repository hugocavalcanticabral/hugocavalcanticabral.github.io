<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<title>Treinamento UFRN</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="refresh" content="120">
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<link rel="stylesheet" href="styles.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
		<script> 
			$(function(){
				$("#header").load("header.html"); 
			});
		</script>
		<script>
			$(function(){
				var jqXhr = $.getJSON("https://api.github.com/repositories/60697123/contents/treinamento", function (data) {})

				.done(function(parsedResponse,statusText,jqXhr) {
					var objeto = jqXhr.responseText;

					var json = $.parseJSON(objeto);
					
					var text = "";
					
					var base_inicio1 = "<a href='?contestNumber=";
					var base_inicio2 ="' onclick=\"load_contest('";
					var base_meio = "')\">";
					var base_fim="</a><br>"
					
					for (var i in json) {
						//console.log(json[i].name);
						if(json[i].name.search("contest ")!=-1){
							var dir;
							dir = base_inicio1;
							dir += (json[i].name.replace("contest ", "")).replace(".txt", "");
							dir +=base_inicio2;
							dir += json[i].download_url;
							dir += base_meio;
							dir += json[i].name.replace(".txt", "");
							dir += base_fim;
					
							text += dir;
						}
					}
					document.getElementById('contestList').innerHTML = text;
				});
			});
		</script>
	</head>
	<body>
		<div id="header"></div>
		<ul class="nav nav-tabs">
			<li><a href="training.html">Rating</a></li>
			<li><a href="contest.html">Contest mode</a></li>
		</ul>
		
		<div class="row">
			<div class="col-xs-5 col-md-3">
				<h4>Contest List</h4>
				<div id="contestList"> </div>
			</div>
			<div class="col-xs-13 col-md-9">
				<div id="clock" align="center"> </div>
				<div id="presentation"> </div>
			</div>
		</div>
	</body>
	<script>
		function time(start, end){
			var actualTime = new Date();
			actualTime = Math.floor(Date.now() / 1000);
			
			if(actualTime<start){
				var dif = start - actualTime;
				var tdif = new Date(dif*1000);
				var h = tdif.getUTCHours();
				var m = tdif.getUTCMinutes();
				var s = tdif.getUTCSeconds();
				if(h<10)h = "0" + h;
				if(m<10)m = "0" + m;
				if(s<10)s = "0" + s;
				
				document.getElementById('clock').innerHTML ="<h3>Contest starts in " + h + ":" + m + ":" + s + "</h3>";
			}
			else if(actualTime<=end){
				var dif = end - actualTime;
				var tdif = new Date(dif*1000);
				var h = tdif.getUTCHours();
				var m = tdif.getUTCMinutes();
				var s = tdif.getUTCSeconds();
				if(h<10)h = "0" + h;
				if(m<10)m = "0" + m;
				if(s<10)s = "0" + s;
				
				document.getElementById('clock').innerHTML ="<h3>Contest ends in " +  h + ":" + m + ":" + s + "</h3>";
			}
			else{
				document.getElementById('clock').innerHTML = "<h3>The contest is finished</h3>";
			}
			
		    var t = setTimeout(time, 1000, start, end);
		}
	</script>
	<script>
		function userStatus(name, lista, start, end, callback){	
			var jqXhr = $.getJSON("http://codeforces.com/api/user.status?handle=" + name + "&from=1&count=100", function (data) {})
			
			.done(function(parsedResponse,statusText,jqXhr) {
				var objeto = jqXhr.responseText;

				var json = $.parseJSON(objeto);
				
				var saida = "";
				var score = 0;
				saida+='{"name" : "' + name + '", "result":[';
				
				if(json["status"]=="OK"){
					for(j=0 ; j<lista.length ; j++){
						var wrong = 0;
						var acc = false;
						
						for(i in json["result"]){
							var q = json["result"][i]["problem"]["contestId"] + "" + json["result"][i]["problem"]["index"];
							
							if(q == lista[j]){
								var t = json["result"][i]["creationTimeSeconds"];
								if(t>=start && t<=end){
									if(acc == false && json["result"][i]["verdict"]!="OK"){ wrong++; }
									else if(acc == false && json["result"][i]["verdict"]=="OK"){
										acc = true;
										score += json["result"][i]["problem"]["points"] - wrong*20;
									}
								}
							}
						}
						
						if(j!=0)saida+=",";
						saida+='{"' + lista[j] + '" :{ "wrong" : ' + wrong + ', "acc" : ' + acc + '}}';
					}
				}
				saida+='], "score": ' + score + '}';
				
				callback(saida);
			})
			.fail(function() {
				userStatus(name, lista, start, end, callback);
			});
		};
	</script>
	<script>
		function createTable(str){
			var json = $.parseJSON(str);
			
			var text = "<table border='1' style='width:100%'> <tr>";
			
			text += " <td align='center' width='120'>" + json["name"] + "</td>";
			text += " <td align='center' width='120'>" + json["score"] + "</td>";
			
			for(i in json["result"]){
				var cont = json["result"][i][Object.keys(json["result"][i])]["wrong"];
				var color = ["#FF0000", "#00FF00", "#FFFFFF"];
				if(json["result"][i][Object.keys(json["result"][i])]["acc"]==true) cont = cont+1;
				
				text += "<td align='center' width='120' bgcolor=";
				if(json["result"][i][Object.keys(json["result"][i])]["acc"]==true) text += color[1];
				else if(cont!=0) text += color[0];
				else text += color[2];
				
				text += ">" + cont + "</td>";
			}
			text += "</tr>";
			document.getElementById('presentation').innerHTML += text;
		}
	</script>
	<script>
		function load_contest(url){
			var objects = [];
			$.get(url, function(data){
				var page = data.split(new RegExp('[\n ]', 'g'));
				
				var startTime = page[0];
				var endTime = page[1];
				
				//CRIANDO O TIME
				time(startTime, endTime);
				
				//CRIANDO O CABEÃ‡ALHO DA TABELA
				var text = "";
				var lista = [];
				text += "<table border='1' style='width:100%'> 	<tr> <td align='center' width='120'>User</td> <td align='center' width='120'>Score</td> ";
				for(i=2 ; i+1<page.length ; i++){
					text += "<td align='center' width='120'><a target='_blank' href=http://codeforces.com/contest/" + page[i].match(new RegExp('[0-9]{0,3}', 'g')) + "/problem/" + page[i].match(new RegExp('[A-Z]', 'g')) + ">" + page[i] + "</a></td>";
					
					lista.push(page[i]);
				}
				//CRIANDO OS OBJETOS DA TABELA(USER, SCORE, ACC SOLUTIONS)
				
				var jqXhr = $.getJSON("https://api.github.com/repositories/60697123/contents/treinamento/users", function (data) {})
				
				.done(function(parsedResponse,statusText,jqXhr) {
					var objeto = jqXhr.responseText;

					var json = $.parseJSON(objeto);
					
					for (var i in json) {
						//console.log(json[i].name);
						var name = json[i].name.replace(".txt", "");
						
						userStatus(name, lista, startTime, endTime, function(str){
							createTable(str);//objects.push(str);
							//console.log(objects); 
						});
					}
				})
				//FINALIZANDO A TABELA E IMPRIMINDO
				text += "</tr>";
				
				document.getElementById('presentation').innerHTML = text;
			});
		};
	</script>
	<script>
		function getUrl( name, url ) {
			if (!url) url = location.href;
			
			name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
			var regexS = "[\\?&]"+name+"=([^&#]*)";
			var regex = new RegExp( regexS );
			var results = regex.exec( url );
			
			//CONTEST NUMBER
			//console.log(results[1]);
			
			if(results!=null) load_contest("https://raw.githubusercontent.com/hugocavalcanticabral/hugocavalcanticabral.github.io/master/treinamento/contest%20" + results[1] + ".txt");
			//return results == null ? null : results[1];
		};
		getUrl('contestNumber');
	</script>
</html>
